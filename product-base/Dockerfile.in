FROM zenoss/centos-base:%BASE_VERSION% AS base

# Predefine users and groups
RUN groupadd zenoss -g 1206 && useradd  zenoss -g zenoss -u 1337 -c "Zenoss Account"

COPY %RPM_LIBSMI% /tmp/

RUN yum install -y --setopt=tsflags="nodocs" /tmp/%RPM_LIBSMI% && yum clean all

COPY my.cnf /etc/my.cnf

RUN mkdir -p /opt/zenoss
RUN chown -R zenoss:zenoss /opt/zenoss /home/zenoss

# ===========================================================================================================

FROM base AS build

COPY %PYDEPS% /tmp/
COPY %JSBUILDER% /tmp/
COPY %PHANTOMJS% /tmp/
COPY %GETPIP% /tmp/
COPY %SOLR% /tmp/
COPY %MIGRATION_WHEEL% /tmp/

COPY %PRODBIN% %METRIC_CONSUMER% %QUERY% %PROTOCOLS% %PYNETSNMP% %EXTJS% %ZEP% %METRICSHIPPER% %ZMINION% %REDISMON% %ZPROXY% %TOOLBOX% %MIGRATION% %MODEL_INDEX% /tmp/

# Install solr
RUN tar -x -f /tmp/%SOLR% -C "/"

# Set SHELL so that subsequent directives execute as the zenoss user.
SHELL ["/bin/su", "-", "zenoss", "-c"]

RUN python /tmp/%GETPIP% --user --no-cache-dir
RUN pip install --user --no-cache-dir virtualenv==16.7.10
RUN virtualenv /opt/zenoss && virtualenv --relocatable /opt/zenoss
RUN echo -e "export ZENHOME=/opt/zenoss\nsource /opt/zenoss/bin/activate\nexport PYTHONPATH=/opt/zenoss/lib/python\nexport PATH=/opt/zenoss/bin:/opt/zenoss/var/ext/bin:$PATH\n" >> /home/zenoss/.bashrc

RUN mkdir -p /tmp/pydeps \
	&& tar -x -f /tmp/%PYDEPS% --strip-components=1 -C /tmp/pydeps \
	&& cd /tmp/pydeps \
	&& pip install --no-index --no-cache-dir --find-links=./wheelhouse -r ./requirements.txt wheel \
	&& cat patches/* | patch -d $(python -c "import pip, os.path; print os.path.dirname(pip.__path__[0])") -p0

RUN unzip -d /tmp/JSBuilder /tmp/%JSBUILDER%
RUN mkdir -p /opt/zenoss/share/java/sencha_jsbuilder-2
RUN cp /tmp/JSBuilder/*.jar /opt/zenoss/share/java/sencha_jsbuilder-2
RUN cp /tmp/JSBuilder/Readme.txt /opt/zenoss/share/java/sencha_jsbuilder-2

RUN mkdir -p /tmp/phantomjs
RUN tar -x -f /tmp/%PHANTOMJS% --strip-components=1 -C /tmp/phantomjs
RUN cp /tmp/phantomjs/bin/phantomjs /opt/zenoss/bin/

# Install the zenoss-prodbin component
RUN tar -C ${ZENHOME} -xzvf /tmp/%PRODBIN% --exclude=Products/ZenModel/migrate/tests --exclude=Products/ZenUITests
# TODO: remove this and make sure the tar file contains the proper links
RUN mkdir -p ${ZENHOME}/etc/supervisor ${ZENHOME}/var/zauth ${ZENHOME}/libexec
RUN ln -s ${ZENHOME}/etc/zauth/zauth_supervisor.conf ${ZENHOME}/etc/supervisor/zauth_supervisor.conf
RUN pip install --no-index --no-cache-dir ${ZENHOME}/dist/*.whl
RUN mv ${ZENHOME}/legacy/sitecustomize.py ${ZENHOME}/lib/python2.7/
RUN rm -rf ${ZENHOME}/dist ${ZENHOME}/legacy
RUN sed -e 's/%VERSION_STRING%/%VERSION%/g; s/%BUILD_NUMBER%/%BUILD%/g' ${ZENHOME}/Products/ZenModel/ZVersion.py.in > ${ZENHOME}/Products/ZenModel/ZVersion.py

# Install MetricConsumer
RUN tar -C ${ZENHOME} -xzvf /tmp/%METRIC_CONSUMER%
RUN chmod +x ${ZENHOME}/bin/metric-consumer-app.sh
RUN ln -s ${ZENHOME}/etc/metric-consumer-app/metric-consumer-app_supervisor.conf ${ZENHOME}/etc/supervisor/metric-consumer-app_supervisor.conf

# Install CentralQuery
RUN tar -C ${ZENHOME} -xzvf /tmp/%QUERY%
RUN chmod +x ${ZENHOME}/bin/central-query.sh
RUN ln -s ${ZENHOME}/etc/central-query/central-query_supervisor.conf ${ZENHOME}/etc/supervisor/central-query_supervisor.conf

# Install zenoss-protocols
RUN pip install --no-index --no-cache-dir /tmp/%PROTOCOLS%

# Install pynetsnmp
RUN pip install --no-index --no-cache-dir /tmp/%PYNETSNMP%

# Install zenoss-extjs
RUN pip install --no-index --no-cache-dir /tmp/%EXTJS%

# Install zep
RUN tar -C ${ZENHOME} -xzvf /tmp/%ZEP%

# Install metricshipper
RUN tar -C ${ZENHOME} -xzvf /tmp/%METRICSHIPPER%

# Install zminion
RUN tar -C ${ZENHOME} -xzvf /tmp/%ZMINION%

# Install redis-mon
RUN tar -C ${ZENHOME} -xzvf /tmp/%REDISMON%

# Install zproxy
RUN tar --strip-components=2 -C ${ZENHOME} -xzvf /tmp/%ZPROXY%

# Install zenoss.toolobx
RUN pip install --no-index --no-cache-dir /tmp/%TOOLBOX%

# Install the servicemigration SDK
RUN pip install --no-index --no-cache-dir /tmp/%MIGRATION%

# Install the zenservicemigration package
RUN pip install --no-index --no-cache-dir /tmp/%MIGRATION_WHEEL%

RUN mkdir /tmp/modelindex \
	&& tar -x -f /tmp/%MODEL_INDEX% -C /tmp/modelindex \
	&& pip install --no-index --no-cache-dir /tmp/modelindex/dist/zenoss.modelindex*

RUN find /opt/zenoss -name \*.py[co] -delete

COPY hubpasswd /opt/zenoss/etc/
COPY install_scripts component_info /opt/zenoss/install_scripts/
COPY zenoss_component_artifact.log /opt/zenoss/log/

# Set SHELL so that subsequent directives execute as the root user (default value).
SHELL ["/bin/sh", "-c"]

RUN rm -rf /opt/solr-6.5.0/server/solr/configsets \
	&& cp -R /tmp/modelindex/zenoss/modelindex/solr/configsets /opt/solr-6.5.0/server/solr/

# ===========================================================================================================

FROM base

COPY --from=build /opt/solr-6.5.0 /opt/solr-6.5.0/
COPY --from=build /var/solr /var/solr/
COPY --from=build /etc/default/solr.in.sh /etc/default/solr.in.sh
RUN ln -s /opt/solr-6.5.0 /opt/solr && chown -R zenoss:zenoss /var/solr
COPY --from=build /home/solr /home/solr/

# Contents of /root/%SHORT_VERSION%.x often changes between releases so it's placed here.
COPY %SHORT_VERSION%.x /root/%SHORT_VERSION%.x

# This directory always changes between releases.
COPY --from=build /opt/zenoss /opt/zenoss/

# While the contents of /home/zenoss shouldn't change much, if at all, between releases, Docker
# always sees a difference between builds (i.e produces a different hash).
COPY --from=build /home/zenoss /home/zenoss/

ENV BUILD_NUMBER %BUILD%
ENV ZENHOME /opt/zenoss
