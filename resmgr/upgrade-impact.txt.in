# This script can be used to upgrade a Zenoss deployment to a new image
#
# To minimize downtime and avoid potential out of space disk issues,
# preseed the master with the images (that the upgrade will automatically
# pull from the internet) before the upgrade maintenance window:
#   ssh MASTER
#       sudo docker pull zenoss/resmgr_%SHORT_VERSION%:%VERSION%  # about 10-20 minutes
#       sudo docker pull zenoss/hbase:%HBASE_VERSION%        # about  5-10 minutes
#       sudo docker pull zenoss/opentsdb:%OPENTSDB_VERSION%      # about  7-15 minutes
#       serviced docker sync                      # about 10m:resmgr 5m:hbase 8m:opentsdb
#
# Run via 'serviced script run upgrade-impact.txt --service Zenoss.resmgr' and restart
# the deployment

###################################################################################
#
# PLEASE READ THE FOLLOWING!
#
# It is required that the entire Zenoss deployment be stopped prior to
# performing an upgrade with this script.
#
###################################################################################

DESCRIPTION  Zenoss RM %VERSION% with Impact upgrade
VERSION   resmgr-%VERSION%
REQUIRE_SVC
SNAPSHOT preupgrade-resmgr-%VERSION%

# Choose image to upgrade to
SVC_USE zenoss/resmgr_%SHORT_VERSION%:%VERSION%_%VERSION_TAG% zenoss/resmgr_5.0 zenoss/resmgr_5.1 zenoss/resmgr_5.2 zenoss/resmgr_5.3 zenoss/resmgr_6.0 zenoss/resmgr_6.1 zenoss/resmgr_6.2 zenoss/resmgr_6.3 zenoss/resmgr_6.4
SVC_USE zenoss/hbase:%HBASE_VERSION%
SVC_USE zenoss/opentsdb:%OPENTSDB_VERSION%
SVC_USE zenoss/mariadb:%VERSION%_%VERSION_TAG%

# Stop Zenoss
# SVC_STOP Zenoss.resmgr auto
# SVC_WAIT Zenoss.resmgr stopped 600

# Run mariadb migration if we upgrade from resmgr < 6.4.0
# - override image for mariadb services to a new one
# - start mariadb services and run mysql_upgrade
%MIGRATE_MARIADB_SERVICES%

# Start all our dependent services
SVC_START Zenoss.resmgr/Infrastructure/mariadb-model
SVC_START Zenoss.resmgr/Infrastructure/mariadb-events
SVC_START Zenoss.resmgr/Infrastructure/RabbitMQ
SVC_START Zenoss.resmgr/Zenoss/Events/zeneventserver
SVC_START Zenoss.resmgr/Infrastructure/redis
SVC_START Zenoss.resmgr/Infrastructure/Impact
SVC_START Zenoss.resmgr/Infrastructure/memcached

# Wait for our services to start
SVC_WAIT Zenoss.resmgr/Infrastructure/mariadb-model Zenoss.resmgr/Infrastructure/mariadb-events Zenoss.resmgr/Infrastructure/RabbitMQ Zenoss.resmgr/Zenoss/Events/zeneventserver Zenoss.resmgr/Infrastructure/redis Zenoss.resmgr/Infrastructure/Impact Zenoss.resmgr/Infrastructure/memcached started 1200

# Run migration to add solr first
SVC_EXEC NO_COMMIT "Zenoss.resmgr/Zenoss/User Interface/Zope" /opt/zenoss/bin/zenmigrate --step=AddSolrService --dont-bump
SVC_START Zenoss.resmgr/Infrastructure/solr
SVC_RESTART Zenoss.resmgr/Zenoss/Events/zeneventserver
SVC_WAIT Zenoss.resmgr/Infrastructure/solr Zenoss.resmgr/Zenoss/Events/zeneventserver started 600

# Run migration to remove product class instance relationships
SVC_EXEC NO_COMMIT "Zenoss.resmgr/Zenoss/User Interface/Zope" /opt/zenoss/bin/zenmigrate --step=RemoveProductClassInstancesRelationship --dont-bump

# Run script to completely remove Catalog Service ZenPack
SVC_EXEC NO_COMMIT "Zenoss.resmgr/Zenoss/User Interface/Zope" su - zenoss -c "/opt/zenoss/bin/remove_CatalogServiceZenPack.sh"

# Run migrations for zenhubworker services
%HUB_SERVICE_MIGRATION%

# Run the upgrade 'run'
SVC_RUN "Zenoss.resmgr/Zenoss/User Interface/Zope" upgrade

# Do a model catalog hard reindex. This is only needed when upgrading to 6.X from 5.X
%UPGRADE_REINDEX%

# Re-run the migration to Remove Empty Product Class Relationships, since it uses the model catalog. This is only needed when upgrading to 6.X from 5.X
%REMOVE_EMPTY_PRODUCT_CLASS_RELATIONSHIPS%

# Fix ZEN-29563 for ZenPacks.zenoss.MultiRealmIP v. < 2.2.4
SVC_EXEC COMMIT "Zenoss.resmgr/Zenoss/User Interface/Zope" su - zenoss -c "/opt/zenoss/bin/fix_MultiRealmIPZenPack.sh"

# Uncomment this to restart the entire application afterwards
# SVC_RESTART Zenoss.resmgr auto

# Uncomment this if you have run the install_quilt script first, and are using
# quilt (based in /opt/zenoss) to manage patches
# SVC_RUN "Zenoss.resmgr/Zenoss/User Interface/Zope" apply-custom-patches
