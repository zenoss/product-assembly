#!/bin/sh
#
###############################################################################
#
# Upgrade UCSPM
#
###############################################################################
set -e
export UCSPM_TENANT_ID="`serviced service list ucspm --format='{{.ID}}'`"
export UPGRADE_REINDEX
export REMOVE_EMPTY_PRODUCT_CLASS_RELATIONSHIPS
BACKUP_DIR="/tmp/upgrade-backup"
echo "Creating backup: the backup process may take a while."
mkdir $BACKUP_DIR
serviced backup $BACKUP_DIR
BACKUP_FILE=$(ls $BACKUP_DIR | sort -n | head -1)

serviced snapshot untag $UCSPM_TENANT_ID preupgrade-ucspm-%VERSION%

FROM_VERSION=$(serviced service list ucspm --format='{{.Version}}')
TO_VERSION=%VERSION%

if [ -z "$FROM_VERSION" ];
then
    FROM_VERSION=$(serviced service list ucspm --format '{{.ImageID}}' | awk '{ print "localhost:5000/"$0" cat /opt/zenoss/Products/ZenModel/ZVersion.py" }' | xargs docker run --rm | grep VERSION | cut -d'"' -f2)
fi

if [ -z "$FROM_VERSION" ];
then
    FROM_VERSION=$(grep 'SVC_USE zenoss/ucspm_[^:_]*:.*' /root/%SHORT_VERSION%.x/current_version.txt | cut -d':' -f2 | cut -d'_' -f1)
    if [ -z "$FROM_VERSION" ];
    then
        echo "Could not get the previous UCSPM version number from serviced, please edit current_version.txt to set it."
        echo "Change this line 'SVC_USE zenoss/ucspm_REPLACE_1' to reflect the pre-upgrade version, for example:"
        echo "SVC_USE zenoss/ucspm_2.0:2.0.0_1"
        exit 1
    else
        echo "Using FROM_VERSION provided by change to current_version.txt"
    fi
fi

FROM_VERSION_SHORT=$(cut -d'.' -f1,2 <<< $FROM_VERSION)
sed -i 's/REPLACE/'"$FROM_VERSION_SHORT:$FROM_VERSION"'/g' /root/%SHORT_VERSION%.x/current_version.txt
serviced script run /root/%SHORT_VERSION%.x/current_version.txt --service ucspm

if [ $(echo "${FROM_VERSION}" | cut -c1) -eq 5 ] && [ $(echo "${TO_VERSION}" | cut -c1) -eq 6 ];
then
    UPGRADE_REINDEX='SVC_EXEC NO_COMMIT "ucspm/Zenoss/User Interface/Zope" su - zenoss -c "/opt/zenoss/bin/upgrade_reindex.sh ucspm"'
    REMOVE_EMPTY_PRODUCT_CLASS_RELATIONSHIPS='SVC_EXEC NO_COMMIT "ucspm/Zenoss/User Interface/Zope" /opt/zenoss/bin/zenmigrate --step=RemoveEmptyProductClassRelationships --dont-bump'
fi

sed -i "s@%UPGRADE_REINDEX%@${UPGRADE_REINDEX}@g; s@%REMOVE_EMPTY_PRODUCT_CLASS_RELATIONSHIPS%@${REMOVE_EMPTY_PRODUCT_CLASS_RELATIONSHIPS}@g;" /root/%SHORT_VERSION%.x/upgrade-ucspm.txt

serviced script run /root/%SHORT_VERSION%.x/upgrade-ucspm.txt --service ucspm && /opt/serviced/bin/serviced-set-version UCSPM %UCSPM_VERSION% || echo "Upgrade failed - performing restore backup." && serviced service stop ucspm && sleep 10 && serviced restore $BACKUP_DIR/$BACKUP_FILE

rm -rf $BACKUP_DIR
